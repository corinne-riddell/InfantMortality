---
title: "Infant Mortality"
author: "Corinne Riddell"
date: "December 16, 2016"
output: html_document
---

```{r, echo=F, warning=F, message=F}
library(ggplot2)
library(plotly)
library(dplyr)
library(gridExtra)
library(grid)
library(epiR)
```

```{r cod_data, echo=F}
#read in the CDC wonder COD-specific mortality data
#for NH blacks and NH whites, stratified by year (1999-2015)
im.cod.dat <-  read.csv("/Users/corinneriddell/Documents/repos/InfantMortality/Data/InfantMortality_by_COD_cleaned.csv", header = T)

im.cod.dat <- im.cod.dat %>% 
  filter(Race %in% c("Black or African American", "White"),
         Hispanic_Origin == "Not Hispanic or Latino") %>%
  select(Race, Year, Deaths, Population, ICD10.130.Infants, Crude_Rate) %>%
  mutate(Race = relevel(Race, ref = "White")) %>%
  mutate(Race = plyr::revalue(Race, c("White"="White", "Black or African American"="Black")),
         Population = as.numeric(as.character(Population)),
         RatePer1000 = (Deaths/Population)*1000,
         ICD10 = as.character(ICD10.130.Infants))

#cod_recode marks those rows that correspond to the 14 leading causes of death
im.cod.dat$cod_recode <- NA
im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == 
                        "#Congenital malformations, deformations and chromosomal abnormalities (Q00-Q99)"] <- "Congenital Malformations"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Congenital Malformations" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == 
                        "#Disorders related to short gestation and low birth weight, not elsewhere classified (P07)"] <- "Short Gestation/LBW"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Short Gestation/LBW" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Sudden infant death syndrome (R95)"] <- "SIDS"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "SIDS" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Newborn affected by maternal complications of pregnancy (P01)"] <- "Maternal Complication of Pregnancy"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Maternal Complication of Pregnancy" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Accidents (unintentional injuries) (V01-X59)"] <- "Accidents"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Accidents" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Newborn affected by complications of placenta, cord and membranes (P02)"] <- "Complications of Placenta, Cord, and Membranes"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Complications of Placenta, Cord, and Membranes" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Respiratory distress of newborn (P22)"] <- "Respiratory Distress"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Respiratory Distress" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Bacterial sepsis of newborn (P36)"] <- "Bacterial Sepsis"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Bacterial Sepsis" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Diseases of the circulatory system (I00-I99)"] <- "Diseases of the Circulatory System"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Diseases of the Circulatory System" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Neonatal hemorrhage (P50-P52,P54)"] <- "Neonatal Hemorrhage"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Neonatal Hemorrhage" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Intrauterine hypoxia and birth asphyxia (P20-P21)"] <- "Intrauterine hypoxia and birth asphyxia"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Intrauterine hypoxia and birth asphyxia" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Necrotizing enterocolitis of newborn (P77)"] <- "Necrotizing enterocolitis"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Necrotizing enterocolitis" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Atelectasis (P28.0-P28.1)"] <- "Atelectasis"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Atelectasis" & is.na(im.cod.dat$cod_recode) == F, ]

im.cod.dat$cod_recode[im.cod.dat$ICD10.130.Infants == "#Assault (homicide) (*U01,X85-Y09)"] <- "Assault"
#table(im.cod.dat$cod_recode)
#im.cod.dat[im.cod.dat$cod_recode == "Assault" & is.na(im.cod.dat$cod_recode) == F, ]

#only keep these rows of data
im.cod.dat2 <- im.cod.dat %>% filter(is.na(cod_recode) == F) %>%
  select(Race, Year, Deaths, Population, RatePer1000, cod_recode)

#calculate the infant mortality rate for the top fifteen causes of infant death
#and store this info in a new data frame called total14
total14 <- im.cod.dat2 %>% group_by(Race, Year) %>%
  summarise(Deaths.top14 = sum(Deaths))

total4 <- im.cod.dat2 %>% group_by(Race, Year) %>%
  filter(cod_recode %in% c("Congenital Malformations", "SIDS", "Short Gestation/LBW", "Maternal Complication of Pregnancy")) %>%
  summarise(Deaths.top4 = sum(Deaths))

im.cod.dat_top4 <- im.cod.dat2 %>% 
  filter(cod_recode %in% c("Congenital Malformations", "SIDS", "Short Gestation/LBW", "Maternal Complication of Pregnancy"))
  
```

```{r notes, echo = F, eval = F}
# 15 leading causes of death by ICD code for infants in 2014
# ref: https://www.cdc.gov/nchs/data/dvs/lcwk7_2014.pdf
#We only considered the top fourteen causes since the rate for the 15th causes was very low and unreliably coded in the earlier years

#Y Congenital malformations, deformations and chromosomal abnormalities (Q00-Q99)	64,181	47,147,656	136.1
#Y Disorders related to short gestation and low birth weight, not elsewhere classified (P07)	58,033	47,147,656	123.1
#Y Sudden infant death syndrome (R95)	29,760	47,147,656	63.1
#Y Newborn affected by maternal complications of pregnancy (P01)	20,990	47,147,656	44.5
#Y Accidents (unintentional injuries) (V01-X59)	15,215	47,147,656	32.3
#Y Newborn affected by complications of placenta, cord and membranes (P02)	13,411	47,147,656	28.4
#Y Respiratory distress of newborn (P22)	9,638	47,147,656	20.4
#Y Bacterial sepsis of newborn (P36)	8,888	47,147,656	18.9
#Y Diseases of the circulatory system (I00-I99)	7,119	47,147,656	15.1
#Y Neonatal hemorrhage (P50-P52,P54)	6,421	47,147,656	13.6
#Y Intrauterine hypoxia and birth asphyxia (P20-P21)	5,567	47,147,656	11.8
#Y Necrotizing enterocolitis of newborn (P77)	5,526	47,147,656	11.7
#Y Atelectasis (P28.0-P28.1)	4,681	47,147,656	9.9
#Y Assault (homicide) (*U01,X85-Y09)	4,027	47,147,656	8.5
#N Diarrhea and gastroenteritis of infectious origin (A09)
```

```{r setup_data, echo=F}
#read in a separate file, where the deaths are aggregated over all COD
#this dataset is stratified by gender, but the previous one was not
im.dat <-  read.csv("/Users/corinneriddell/Documents/repos/InfantMortality/Data/InfantMortalityData.csv",
                      header = T)

imdat.subset <- im.dat %>% 
  filter(Race %in% c("Black or African American", "White"),
         Hispanic_Origin == "Not Hispanic or Latino") %>%
  select(Race, Year, Gender, Deaths, Population, Crude_Rate) %>%
  mutate(Race = relevel(Race, ref = "White")) %>%
  mutate(Race = droplevels(Race)) %>%
  mutate(Race = plyr::revalue(Race, c("White"="White", "Black or African American"="Black")),
         Population = as.numeric(as.character(Population)),
         RatePer1000 = (Deaths/Population)*1000)

totals <- imdat.subset %>% group_by(Race, Year) %>% 
  summarise(Deaths.all = sum(Deaths), #this sums across gender
            Population = sum(Population)) 

#this dataset contains overall death counts ("Deaths.all") and the deaths from the top 14 causes ("Deaths.top14")
totals <- merge(totals, total14, by = c("Race", "Year"))

totals_top4 <- merge(totals, total4, by = c("Race", "Year"))

#calculate the rate of deaths from all other causes
totals <- totals %>% mutate(Deaths = Deaths.all - Deaths.top14,
                            RatePer1000 = (Deaths/Population)*1000,
                            cod_recode = "All other causes") %>%
                     select(Race, Year, Population, Deaths, RatePer1000, cod_recode) 

#calculate the rate of deaths from all other causes
totals_top4 <- totals_top4 %>% mutate(Deaths = Deaths.all - Deaths.top4,
                            RatePer1000 = (Deaths/Population)*1000,
                            cod_recode = "All other causes") %>%
                     select(Race, Year, Population, Deaths, RatePer1000, cod_recode) 

#add in the "All other causes" data to the COD-specific data
im.cod.dat3 <- rbind(im.cod.dat2, totals)  
im.cod.dat3$cod_recode <- factor(im.cod.dat3$cod_recode)

im.cod.dat_top4 <- rbind(im.cod.dat_top4, totals)  
im.cod.dat_top4$cod_recode <- factor(im.cod.dat_top4$cod_recode)

#order the factor variable 
im.cod.dat3$cod_recode <- reorder(im.cod.dat3$cod_recode, im.cod.dat3$RatePer1000, max)
im.cod.dat3$cod_recode2 <- factor(im.cod.dat3$cod_recode, levels = rev(levels(im.cod.dat3$cod_recode)))

im.cod.dat_top4$cod_recode <- reorder(im.cod.dat_top4$cod_recode, im.cod.dat_top4$RatePer1000, max)
im.cod.dat_top4$cod_recode2 <- factor(im.cod.dat_top4$cod_recode, levels = rev(levels(im.cod.dat_top4$cod_recode)))
```

```{r reshape_long_to_wide, echo=F}

data.chosen <- im.cod.dat_top4

black2 <- subset(data.chosen, Race == "Black") %>% 
  select(Year, RatePer1000, Population, Deaths, cod_recode, cod_recode2) %>%
  rename(Black_IMR = RatePer1000, Black.Pop = Population,
         Black.Deaths = Deaths)

white2 <- subset(data.chosen, Race == "White") %>% 
  select(Year, RatePer1000, Population, Deaths, cod_recode, cod_recode2) %>%
  rename(White_IMR = RatePer1000, White.Pop = Population,
         White.Deaths = Deaths)

both.cod <- merge(black2, white2, by = c("Year", "cod_recode", "cod_recode2"))

both.cod <- both.cod %>% mutate(RR = Black_IMR/White_IMR, RD = Black_IMR - White_IMR,
                                SD_RD = (((Black.Deaths*(Black.Pop - Black.Deaths))/(Black.Pop^3)) + 
                                   ((White.Deaths*(White.Pop - White.Deaths))/(White.Pop^3)))^0.5,
                                UCL_RD = RD + 1.96*SD_RD*1000, LCL_RD = RD - 1.96*SD_RD*1000, 
                                SD_lnRR = ((1/Black.Deaths)-(1/(Black.Pop-Black.Deaths))+(1/White.Deaths)-(1/(White.Pop-White.Deaths)))^0.5,
                                UCL_RR = exp(log(RR) + 1.96*SD_lnRR), LCL_RR = exp(log(RR) - 1.96*SD_lnRR))
```

```{r long_to_wide_data, echo=F}
black <- subset(imdat.subset, Race == "Black") %>% 
  select(Year, Gender, RatePer1000, Population, Deaths) %>%
  rename(Black_IMR = RatePer1000, Black.Pop = Population,
         Black.Deaths = Deaths)

white <- subset(imdat.subset, Race == "White") %>% 
  select(Year, Gender, RatePer1000, Population, Deaths) %>%
  rename(White_IMR = RatePer1000, White.Pop = Population,
         White.Deaths = Deaths)

both <- merge(black, white, by = c("Year", "Gender"))
both <- both %>% mutate(RR = Black_IMR/White_IMR, RD = Black_IMR - White_IMR,
                        SD_RD = (((Black.Deaths*(Black.Pop - Black.Deaths))/(Black.Pop^3)) + 
                                   ((White.Deaths*(White.Pop - White.Deaths))/(White.Pop^3)))^0.5,
         UCL_RD = RD + 1.96*SD_RD*1000, LCL_RD = RD - 1.96*SD_RD*1000, 
                  SD_lnRR = ((1/Black.Deaths)-(1/(Black.Pop-Black.Deaths))+(1/White.Deaths)-(1/(White.Pop-White.Deaths)))^0.5,
         UCL_RR = exp(log(RR) + 1.96*SD_lnRR), LCL_RR = exp(log(RR) - 1.96*SD_lnRR))

#formulas for the standard errors of the RR and RD found in Baby Rothman
aggregate.sex <- both %>% group_by(Year) %>%
  summarise(Black.Pop = sum(Black.Pop), White.Pop = sum(White.Pop),
            Black.Deaths = sum(Black.Deaths), White.Deaths = sum(White.Deaths)) %>%
  mutate(Black_IMR = (Black.Deaths/Black.Pop)*1000,
         White_IMR = (White.Deaths/White.Pop)*1000) %>%
  mutate(RR = Black_IMR/White_IMR, RD = Black_IMR - White_IMR,
         SD_RD = (((Black.Deaths*(Black.Pop - Black.Deaths))/(Black.Pop^3)) + ((White.Deaths*(White.Pop - White.Deaths))/(White.Pop^3)))^0.5,
         UCL_RD = RD + 1.96*SD_RD*1000, LCL_RD = RD - 1.96*SD_RD*1000,
         SD_lnRR = ((1/Black.Deaths)-(1/(Black.Pop-Black.Deaths))+(1/White.Deaths)-(1/(White.Pop-White.Deaths)))^0.5,
         UCL_RR = exp(log(RR) + 1.96*SD_lnRR), LCL_RR = exp(log(RR) - 1.96*SD_lnRR),
         Gender = "Both Genders")

both2 <- rbind(both, aggregate.sex)
```

```{r imr_plot, echo=F, fig.width=9, fig.height=3}
first <- ggplot(subset(both2, Gender == "Both Genders" & Year >= 2005), aes(x = Year, y = Black_IMR))  + 
  geom_segment(aes(y = 0, yend = 14.3, x=2005, xend=2005), lty =3, col = "grey37", lwd = 0.5) +
  geom_segment(aes(y = 0, yend = 11.1, x=2012, xend=2012), lty =3, col = "grey37", lwd = 0.5) + 
  geom_segment(aes(y = 0, yend = 11.2, x=2015, xend=2015), lty =3, col = "grey37", lwd = 0.5) +
  #geom_ribbon(aes(ymin= Black_IMR, ymax = White_IMR), col = "grey", alpha=0.2) +
  geom_line(aes(col = "Black")) + 
  geom_line(aes(y = White_IMR, col = "White")) +
  ylab("IMR (per 1,000)") + 
  scale_y_continuous(limits = c(0, 15.5), breaks = seq(from=0, to=15, by = 3), minor_breaks = seq(from=0, to=15, by = 1)) + 
  scale_x_continuous(limits = c(2005, 2016), breaks = seq(from=2005, to=2015.5, by = 2)) +
  scale_color_manual(values = c("#b2182b", "#2166ac"), guide = guide_legend(title = "")) +
  theme_bw() + theme(legend.position = "none") + ggtitle("a) Infant Mortality Rates (IMR)") +
  geom_text(aes(x = 2015.7, y = 4.9), label = "White", col = "#2166ac", check_overlap = T) +
  geom_text(aes(x = 2015.7, y = 11.2), label = "Black", col = "#b2182b", check_overlap = T) +
  geom_text(data = subset(both2, Gender == "Both Genders" & Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = Black_IMR + 1, label = round(Black_IMR,1)), col = "#b2182b") +
  geom_text(data = subset(both2, Gender == "Both Genders" & Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = White_IMR + 1, label = round(White_IMR,1)), col = "#2166ac")  

first
```

```{r RR_plot, echo=F, fig.width=8, fig.height=2}
second <- ggplot(subset(both2, Gender == "Both Genders" & Year >= 2005), aes(x = Year, y = RR))  + 
  geom_segment(aes(y = 1, yend = 2.4, x=2005, xend=2005), lty =3, col = "grey37", lwd = 0.5) +
  geom_segment(aes(y = 1, yend = 2.2, x=2012, xend=2012), lty =3, col = "grey37", lwd = 0.5) + 
  geom_segment(aes(y = 1, yend = 2.3, x=2015, xend=2015), lty =3, col = "grey37", lwd = 0.5) +
  geom_line() + #geom_ribbon(aes(ymin = LCL_RR, ymax = UCL_RR), col = "grey", alpha = 0.5) + 
  ylab("Risk Ratio") + #scale_y_continuous(trans = log, limits = c())
  scale_x_continuous(limits = c(2005, 2016), breaks = seq(from=2005, to=2015.5, by = 2)) +
  geom_text(data = subset(both2, Gender == "Both Genders" & Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = RR + 0.05, label = round(RR,1))) +
  scale_y_continuous(trans = "log10", limits = c(1, 2.5), breaks = seq(from=1, to=2.5, by = 0.5)) +
  theme_bw() + ggtitle("b) Risk ratio")
```

```{r RD_plot, echo=F, fig.width=8, fig.height=2}
third <- ggplot(subset(both2, Gender == "Both Genders" & Year >= 2005), aes(x = Year, y = RD))  + 
  geom_segment(aes(y = 0, yend = 8.4, x=2005, xend=2005), lty =3, col = "grey37", lwd = 0.5) +
  geom_segment(aes(y = 0, yend = 6.0, x=2012, xend=2012), lty =3, col = "grey37", lwd = 0.5) + 
  geom_segment(aes(y = 0, yend = 6.3, x=2015, xend=2015), lty =3, col = "grey37", lwd = 0.5) +
  geom_line() + #geom_ribbon(aes(ymin = LCL_RD, ymax = UCL_RD), col = "grey", alpha = 0.5) +
  ylab("Excess risk (per 1,000)") + 
  scale_y_continuous(limits = c(0, 10), breaks = seq(from=0, to=10, by = 3), minor_breaks = seq(from=0, to=9, by = 1)) +
  scale_x_continuous(limits = c(2005, 2016), breaks = seq(from=2005, to=2015.5, by = 2)) +
  theme_bw() + ggtitle("b) Excess risk") +
    geom_text(data = subset(both2, Gender == "Both Genders" & Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = RD + 0.5, label = round(RD,1))) 
```

**Figure 1: Infant mortality and excess risk of death for blacks compared with whites, United States, 2010-2015**
```{r all_three, fig.width=3.5, fig.height=7, echo=F}
#grid.arrange(first, second, third, nrow = 3, heights = c(0.5, 0.25, 0.25))
grid.arrange(first, third, nrow = 2, heights = c(0.5, 0.5))
```

(The plots for the RR and RD contain their 95% CIs.)

Infant mortality for whites decreased from 5.01 deaths per 1,000 in 2014 to 4.95 deaths per 1,000 in 2015. At the same time, infant mortality among black infants increased from 11.01 to 11.23 per 1,000 over the same time period. While the absolute size of this increase among blacks may seem small (~ 0.22 additional deaths per 1,000 infants), it means that an additional 1XX black infants died of those 5XX,XXX born in 2015 (compared to the 2014 level).

The risk ratio increased to 2.27 from 2.19, implying 2.27 times more infant deaths among blacks compared with whites.

The risk difference, an absolute measure of risk was 6.00/1000 in 2014 and increased to 6.29/1000 in 2015. 
Number of black infant deaths in 2015: 6907 for 614972 population
If blacks had rates of whites in 2015: 3041 for 614972 population
--> 6907/3041 = 2.27, 6907-3041 = 3866 additional deaths per 614972 --> X per 1000

**Exploration of COD plots**

**1) Trends in COD-specific mortality since 2010**

```{r COD_trends_IMR, echo=F, fig.width=10, fig.height=10}
a <- ggplot(subset(both.cod, Year >= 2005), aes(x = Year, y = Black_IMR)) + 
  #geom_ribbon(aes(ymin= Black_IMR, ymax = White_IMR), col = "grey", alpha=0.2) +
  geom_segment(data = subset(both.cod, Year %in% c(2005, 2012, 2015)), aes(yend = Black_IMR, y = 0, xend = Year), lty = 3) +
  geom_line(aes(col = "Black")) + facet_wrap(~cod_recode2) +
  geom_line(aes(y = White_IMR, col = "White")) +   
  theme_bw() + ylab("Cause-Specific Infant Mortality Rate (per 1,000)") +
  ggtitle("Trends in cause-specific infant mortality rates over time for black and whites, United States 2010-2015") +
  scale_color_manual(values = c("#b2182b", "#2166ac"), guide = guide_legend(title = "")) +
  scale_y_continuous(limits = c(0, 4.5), breaks = seq(from=0, to=4, by = 1), minor_breaks = seq(from=0, to=4, by = 0.5)) +
  scale_x_continuous(limits = c(2005, 2016), breaks = seq(from=2005, to=2015.5, by = 2)) +
  geom_text(data = subset(both.cod, Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = Black_IMR + 0.2, label = round(Black_IMR,1)), col = "#b2182b") +
  geom_text(data = subset(both.cod, Year %in% c(2005, 2012, 2015)), 
            aes(x = Year, y = White_IMR - 0.3, label = round(White_IMR,1)), col = "#2166ac")  

a
```



-notice that the y-axis is free (different for each plot), and the plots are organized by descreasing IMRs
-of four causes that contributed the most to mortality (i.e., those in the top row), three saw increases in 2015 vs. 2014 for blacks but not for whites (congenital malformations, SIDS, all other causes).
-thus, it is the relative changes in the rates of mortality for these causes that had the largest affect on increasing the IMR more for blacks. vs. whites.
-would we want to show all panels or just a subset? 

**2) Trends in the cause-specific risk ratios**

```{r COD_RiskRatio, fig.width=8, fig.height=6, echo=F}
ggplot(subset(both.cod, Year>= 2010), aes(x = Year, y = RR))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Ratio") + facet_wrap(~cod_recode2) +
  geom_ribbon(aes(ymin = LCL_RR, ymax = UCL_RR), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the relative risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")
```

**3) Trends in the cause-specific risk differences**

```{r COD_RiskDifference, fig.width=9, fig.height=6, echo=F}
ggplot(subset(both.cod, Year>= 2010), aes(x = Year, y = RD))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Difference (excess deaths per 1,000)") + facet_wrap(~cod_recode2, scales = "free_y") +
  geom_ribbon(aes(ymin = LCL_RD, ymax = UCL_RD), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the excess risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")
```

**4) Stacked bar charts for 2014 vs. 2015**

```{r, fig.width=6.5, fig.height=4.5, echo=F}
ggplot(arrange(subset(both.cod, Year >= 2014), desc(cod_recode)), aes(x = Year, y = Black_IMR, fill=cod_recode)) +
    geom_bar(stat='identity', col = "white") + theme_minimal() + ylab("Infant mortality rate (per 1000)") +
  ggtitle("Black")

ggplot(arrange(subset(both.cod, Year >= 2014), desc(cod_recode)), aes(x = Year, y = White_IMR, fill=cod_recode)) +
    geom_bar(stat='identity', col = "white") + theme_minimal() + ylab("Infant mortality rate (per 1000)") +
  ggtitle("White")
```

-I find these somewhat hard to interpret because hard to isolate the COD-specific changes due to the stacking. 

**5) Alternative: Stacked bar charts for 2010-2015 with reversed stacking order**

```{r, fig.width=6, fig.height=4.5, echo=F}
ggplot(arrange(subset(both.cod, Year >= 2010), cod_recode), aes(x = Year, y = Black_IMR, fill=cod_recode)) +
    geom_bar(stat='identity', col = "white") + theme_minimal() + ylab("Infant mortality rate (per 1000)") +
  ggtitle("Black")

ggplot(arrange(subset(both.cod, Year >= 2010), cod_recode), aes(x = Year, y = White_IMR, fill=cod_recode)) +
    geom_bar(stat='identity', col = "white") + theme_minimal() + ylab("Infant mortality rate (per 1000)") +
  ggtitle("White")
```

Again, I find this hard to interpret.






**Supplementary plots**
Slightly different from those figures featured above.

```{r more_plots1, echo=F}
ggplot(both2, aes(x = Year, y = Black_IMR))  + 
  geom_ribbon(aes(ymin= Black_IMR, ymax = White_IMR), col = "grey", alpha=0.2) +
  geom_line(aes(col = "Black"), lwd = 1.5) + 
  geom_line(aes(y = White_IMR, col = "White"), lwd = 1.5) +
  facet_wrap(~ Gender) + ylab("Infant Mortality Rate (per 1,000)") +
  scale_color_manual(values = c("#b2182b", "#2166ac")) +
  theme_minimal()

ggplot(both2, aes(x = Year, y = RR))  + 
  geom_line(lwd = 1.5) + 
  facet_wrap(~ Gender) + ylab("Relative risk") +
  theme_minimal()

ggplot(both2, aes(x = Year, y = RD))  + 
  geom_line(lwd = 1.5) + 
  facet_wrap(~ Gender) +
  ylab("Excess risk") +
  theme_minimal()

ggplot(both.cod, aes(x = Year, y = Black_IMR)) + 
  geom_ribbon(aes(ymin= Black_IMR, ymax = White_IMR), col = "grey", alpha=0.2) +
  geom_line(aes(col = "Black")) + facet_wrap(~cod_recode2, scales = "free_y") +
  geom_line(aes(y = White_IMR, col = "White")) +   
  theme_minimal() + ylab("Cause-Specific Infant Mortality Rate (per 1,000)") +
  ggtitle("Trends in cause-specific infant mortality rates over time for black and whites, United States 1999-2015") +
  scale_color_manual(values = c("#b2182b", "#2166ac"), guide = guide_legend(title = ""))


ggplot(both.cod, aes(x = Year, y = RR))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Ratio") + facet_wrap(~cod_recode2, scales = "free_y") +
  geom_ribbon(aes(ymin = LCL_RR, ymax = UCL_RR), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the relative risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")

ggplot(both.cod, aes(x = Year, y = RR))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Ratio") + facet_wrap(~cod_recode2) +
  geom_ribbon(aes(ymin = LCL_RR, ymax = UCL_RR), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the relative risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")

ggplot(both.cod, aes(x = Year, y = RD))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Difference (excess deaths per 1,000)") + facet_wrap(~cod_recode2, scales = "free_y") + 
  geom_ribbon(aes(ymin = LCL_RD, ymax = UCL_RD), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the excess risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")

ggplot(both.cod, aes(x = Year, y = RD))  + 
  geom_line(lwd = 1.5) + #, aes(col = cod_recode)) + 
  ylab("Risk Difference (excess deaths per 1,000)") + facet_wrap(~cod_recode2) + 
  geom_ribbon(aes(ymin = LCL_RD, ymax = UCL_RD), col = "grey", alpha = 0.5) +
  theme_minimal() + ggtitle("Trends in the excess risk of cause-specific infant mortality over time comparing blacks to whites, United States 1999-2015")
```

```{r more_plots, echo=F, eval=F}
a <- ggplotly(
ggplot(both, aes(y = RR, x = Year)) + geom_line() +
  theme_minimal() + facet_wrap(~ Gender) + ylab("")) %>%
  layout(yaxis = list(title = "Risk Ratio"))

b <- ggplotly(
ggplot(both, aes(y = RD, x = Year)) + geom_line() +
  theme_minimal() + facet_wrap(~ Gender) + ylab("")) %>%
  layout(yaxis = list(title = "Risk Difference"))

c <- ggplotly( 
ggplot(both, aes(y = Black_IMR, x = Year)) +
  geom_ribbon(aes(ymin = Black_IMR, ymax = White_IMR), col = "grey", alpha = 0.2) +
  facet_wrap(~ Gender) + 
  geom_line(col = "#b2182b") + 
  geom_line(aes(y = White_IMR), col = "#2166ac") +
  theme_minimal() + ylab("")) %>%
  layout(yaxis = list(title = "Infant Mortality Rate"))

subplot(c, a, b, nrows = 3, titleY = T)

ggplot(imdat.subset, aes(x = Year, y = RatePer1000)) + 
  geom_line(aes(col = Race), lwd = 2) +
  theme_minimal() + facet_wrap(~Gender) +
  ylab("Infant Mortality Rate (per 1,000)")

```



